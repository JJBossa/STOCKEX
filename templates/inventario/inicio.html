{% extends 'base.html' %}

{% block title %}STOCKEX{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-house-door"></i> Inicio
        </li>
    </ol>
</nav>

{% if es_admin %}
<div class="alert alert-info border-0 mb-4" role="alert" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 1px solid #93c5fd !important;">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex align-items-center">
            <i class="bi bi-shield-check-fill me-2" style="font-size: 1.5rem; color: #2563eb;"></i>
            <div>
                <strong style="color: #1e40af;">Modo Administrador</strong>
                <small class="d-block text-muted">Puedes editar y agregar productos</small>
            </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
            <a href="{% url 'dashboard' %}" class="btn btn-info btn-sm">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{% url 'punto_venta' %}" class="btn btn-success btn-sm">
                <i class="bi bi-cash-register"></i> Punto de Venta
            </a>
            <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear"></i> Administración
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'listar_usuarios' %}"><i class="bi bi-people text-warning"></i> Usuarios</a></li>
                    <li><a class="dropdown-item" href="{% url 'gestionar_categorias' %}"><i class="bi bi-tags text-secondary"></i> Categorías</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'listar_facturas' %}"><i class="bi bi-receipt text-success"></i> Facturas</a></li>
                    <li><a class="dropdown-item" href="{% url 'listar_cotizaciones' %}"><i class="bi bi-file-earmark-text text-info"></i> Cotizaciones</a></li>
                    <li><a class="dropdown-item" href="{% url 'listar_movimientos' %}"><i class="bi bi-arrow-left-right text-info"></i> Movimientos</a></li>
                    <li><a class="dropdown-item" href="{% url 'reportes_avanzados' %}"><i class="bi bi-graph-up text-primary"></i> Reportes</a></li>
                    <li><a class="dropdown-item" href="{% url 'graficos_ventas' %}"><i class="bi bi-bar-chart-line text-primary"></i> Gráficos de Ventas</a></li>
                </ul>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-tools"></i> Herramientas
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'imprimir_etiquetas' %}"><i class="bi bi-printer"></i> Imprimir Etiquetas</a></li>
                    <li><a class="dropdown-item" href="{% url 'imprimir_lista_precios' %}"><i class="bi bi-file-earmark-pdf"></i> Lista de Precios</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'gestionar_backups' %}"><i class="bi bi-database"></i> Backups</a></li>
                </ul>
            </div>
            <a href="{% url 'agregar_producto' %}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle"></i> Agregar Producto
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="stats-card">
    <div class="row text-center">
        <div class="col-md-3">
            <h3><i class="bi bi-boxes"></i></h3>
            <h4>{{ total_productos }}</h4>
            <p class="mb-0">Total Productos</p>
        </div>
        <div class="col-md-3">
            <h3><i class="bi bi-search"></i></h3>
            <h4>{% if query or categoria_id or precio_min or precio_max or stock_bajo or con_imagen %}{{ productos.paginator.count }}{% else %}{{ total_productos }}{% endif %}</h4>
            <p class="mb-0">{% if query or categoria_id or precio_min or precio_max or stock_bajo or con_imagen %}Resultados{% else %}Mostrando{% endif %}</p>
        </div>
        <div class="col-md-3">
            <h3><i class="bi bi-exclamation-triangle"></i></h3>
            <h4>{{ productos_stock_bajo_count }}</h4>
            <p class="mb-0">Stock Bajo</p>
        </div>
        <div class="col-md-3">
            <h3><i class="bi bi-list-ul"></i></h3>
            <h4>{{ productos.paginator.num_pages }}</h4>
            <p class="mb-0">Página{{ productos.paginator.num_pages|pluralize }}</p>
        </div>
    </div>
</div>

<div class="search-container">
    <form method="get" action="{% url 'inicio' %}" class="row g-3" id="search-form">
        <div class="col-md-6">
            <div class="input-group input-group-lg">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" 
                       class="form-control" 
                       name="q" 
                       id="search-input"
                       value="{{ query }}" 
                       placeholder="Buscar o escanear código de barras..."
                       autofocus
                       autocomplete="off"
                       aria-label="Buscar productos"
                       aria-describedby="search-help">
            </div>
            <small class="text-muted" id="search-help">
                <i class="bi bi-info-circle"></i> 
                {% if es_admin %}
                Escanea con lector de código de barras o presiona <kbd>Ctrl+K</kbd> para buscar
                {% else %}
                Escribe el nombre del producto o escanea su código de barras
                {% endif %}
            </small>
        </div>
        <div class="col-md-3">
            <label class="form-label small text-muted d-block mb-1">
                <i class="bi bi-tags"></i> Categoría
            </label>
            <select name="categoria" class="form-select form-select-lg">
                <option value="">Todas las categorías</option>
                {% for cat in categorias %}
                <option value="{{ cat.id }}" {% if categoria_id == cat.id|stringformat:"s" %}selected{% endif %}>
                    {{ cat.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small text-muted d-block mb-1">
                <i class="bi bi-sort-down"></i> Ordenar por
            </label>
            <select name="orden" class="form-select form-select-lg">
                <option value="nombre_asc" {% if orden == 'nombre_asc' %}selected{% endif %}>Nombre (A-Z)</option>
                <option value="nombre_desc" {% if orden == 'nombre_desc' %}selected{% endif %}>Nombre (Z-A)</option>
                <option value="precio_asc" {% if orden == 'precio_asc' %}selected{% endif %}>Precio: Más Barato</option>
                <option value="precio_desc" {% if orden == 'precio_desc' %}selected{% endif %}>Precio: Más Caro</option>
                {% if es_admin %}
                <option value="stock_asc" {% if orden == 'stock_asc' %}selected{% endif %}>Stock: Menor a Mayor</option>
                <option value="stock_desc" {% if orden == 'stock_desc' %}selected{% endif %}>Stock: Mayor a Menor</option>
                <option value="fecha_desc" {% if orden == 'fecha_desc' %}selected{% endif %}>Más Recientes</option>
                {% endif %}
            </select>
        </div>
        
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Buscar
                </button>
                <a href="{% url 'inicio' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
                
                {% if es_admin %}
                <!-- Botón para mostrar/ocultar filtros avanzados (solo admin) -->
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#filtrosAvanzados" aria-expanded="false" aria-controls="filtrosAvanzados">
                    <i class="bi bi-sliders"></i> Más filtros
                </button>
                {% endif %}
                
                <!-- Selector de vista compacto -->
                <div class="btn-group" role="group" aria-label="Vista">
                    <input type="radio" class="btn-check" name="vista" id="vistaGrid" value="grid" {% if vista == 'grid' %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-secondary" 
                           for="vistaGrid" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="bottom" 
                           title="Vista de cuadrícula (tarjetas)">
                        <i class="bi bi-grid-3x3-gap"></i>
                    </label>
                    <input type="radio" class="btn-check" name="vista" id="vistaLista" value="lista" {% if vista == 'lista' %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-secondary" 
                           for="vistaLista" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="bottom" 
                           title="Vista de lista (compacta)">
                        <i class="bi bi-list-ul"></i>
                    </label>
                </div>
                
                {% if es_admin %}
                <!-- Menú desplegable para exportar -->
                <div class="dropdown">
                    <button class="btn btn-outline-success dropdown-toggle" 
                            type="button" 
                            data-bs-toggle="dropdown" 
                            aria-expanded="false"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom" 
                            title="Exporta la lista de productos en diferentes formatos">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" 
                               href="{% url 'exportar_excel' %}"
                               data-bs-toggle="tooltip" 
                               data-bs-placement="left" 
                               title="Exportar a Excel (.xlsx)">Excel (.xlsx)</a></li>
                        <li><a class="dropdown-item" 
                               href="{% url 'exportar_pdf' %}"
                               data-bs-toggle="tooltip" 
                               data-bs-placement="left" 
                               title="Exportar a PDF">PDF</a></li>
                        <li><a class="dropdown-item" 
                               href="{% url 'exportar_csv' %}"
                               data-bs-toggle="tooltip" 
                               data-bs-placement="left" 
                               title="Exportar a CSV (valores separados por comas)">CSV</a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Filtros avanzados colapsables -->
        <div class="collapse mt-3" id="filtrosAvanzados">
            <div class="card card-body bg-light">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small text-muted"><i class="bi bi-currency-dollar"></i> Precio Mínimo</label>
                        <input type="number" name="precio_min" class="form-control" placeholder="Min" value="{{ precio_min }}" step="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted"><i class="bi bi-currency-dollar"></i> Precio Máximo</label>
                        <input type="number" name="precio_max" class="form-control" placeholder="Max" value="{{ precio_max }}" step="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted"><i class="bi bi-exclamation-triangle"></i> Stock</label>
                        <select name="stock_bajo" class="form-select">
                            <option value="">Todos</option>
                            <option value="1" {% if stock_bajo == '1' %}selected{% endif %}>Solo Stock Bajo</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted"><i class="bi bi-image"></i> Imagen</label>
                        <select name="con_imagen" class="form-select">
                            <option value="">Todos</option>
                            <option value="1" {% if con_imagen == '1' %}selected{% endif %}>Con Imagen</option>
                            <option value="0" {% if con_imagen == '0' %}selected{% endif %}>Sin Imagen</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% if not es_admin and not query and not categoria_id %}
<div class="alert alert-info border-0 shadow-sm mb-4">
    <div class="d-flex align-items-start">
        <div class="me-3">
            <i class="bi bi-lightbulb" style="font-size: 2rem;"></i>
        </div>
        <div>
            <h5 class="alert-heading mb-2"><i class="bi bi-info-circle"></i> ¿Cómo buscar productos?</h5>
            <p class="mb-2">Es muy fácil encontrar lo que necesitas:</p>
            <ul class="mb-0">
                <li><strong>Por nombre:</strong> Escribe el nombre del producto en el cuadro de búsqueda</li>
                <li><strong>Por código:</strong> Escanea el código de barras con el lector</li>
                <li><strong>Por categoría:</strong> Selecciona una categoría del menú desplegable</li>
            </ul>
        </div>
    </div>
</div>
{% endif %}

{% if productos_stock_bajo_count > 0 %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> 
    <strong>Atención:</strong> Hay {{ productos_stock_bajo_count }} producto(s) con stock bajo.
    {% if es_admin %}
    <a href="{% url 'inicio' %}?stock_bajo=1" class="btn btn-warning btn-sm ms-2">Ver Productos con Stock Bajo</a>
    {% endif %}
</div>
{% endif %}

{% if productos %}
<div class="{% if vista == 'lista' %}vista-lista{% else %}row{% endif %}">
    {% for producto in productos %}
    <div class="{% if vista == 'lista' %}col-12{% else %}col-md-4 col-lg-3{% endif %}">
        <div class="card card-producto h-100">
            {% if producto.imagen %}
            <img data-src="{{ producto.imagen.url }}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200'%3E%3Crect fill='%23f0f0f0' width='300' height='200'/%3E%3C/svg%3E" class="card-img-top producto-imagen lazy" alt="{{ producto.nombre }}" loading="lazy">
            {% else %}
            <div class="card-img-top d-flex align-items-center justify-content-center producto-placeholder">
                <i class="bi bi-image producto-placeholder-icon"></i>
            </div>
            {% endif %}
            <div class="card-body">
                {% if vista == 'lista' %}
                <div class="producto-info">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-2">
                            <i class="bi bi-box-seam text-primary"></i>
                            <a href="{% url 'detalle_producto' producto.id %}" class="text-decoration-none text-dark">
                                {{ producto.nombre }}
                            </a>
                        </h5>
                        {% if producto.sku %}
                        <small class="text-muted d-block mb-2"><i class="bi bi-upc"></i> SKU: {{ producto.sku }}</small>
                        {% endif %}
                        <button class="btn btn-sm btn-link p-0 favorito-btn" 
                                data-producto-id="{{ producto.id }}"
                                data-favorito="{% if producto.id in favoritos_ids %}true{% else %}false{% endif %}"
                                onclick="toggleFavorito({{ producto.id }}, this)"
                                data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                title="{% if producto.id in favoritos_ids %}Quitar de favoritos - Accede rápido desde el menú{% else %}Agregar a favoritos - Accede rápido desde el menú{% endif %}">
                            <i class="bi {% if producto.id in favoritos_ids %}bi-star-fill text-warning{% else %}bi-star{% endif %}"></i>
                        </button>
                        {% if producto.categoria %}
                        <span class="badge badge-categoria mb-2" style="background-color: {{ producto.categoria.color }};">
                            {{ producto.categoria.nombre }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-center min-width-120">
                        {% if producto.precio_promo %}
                        <div class="mb-1">
                            <small class="text-muted">Precio unidad:</small>
                            <div class="text-muted">${{ producto.precio|floatformat:0 }}</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Precio promo:</small>
                            <div class="precio text-success">
                                <strong>${{ producto.precio_promo|floatformat:0 }}</strong>
                            </div>
                        </div>
                        {% else %}
                        <div class="mb-1">
                            <small class="text-muted">Precio unidad:</small>
                        </div>
                        <div class="precio mb-2">${{ producto.precio|floatformat:0 }}</div>
                        {% endif %}
                        <div class="d-flex align-items-center gap-2">
                            <div id="stock-display-list-{{ producto.id }}">
                                {% if producto.stock > 10 %}
                                <span class="badge bg-success badge-stock">
                                    <i class="bi bi-check-circle"></i> <span class="stock-value">{{ producto.stock }}</span>
                                </span>
                                {% elif producto.stock > 0 %}
                                <span class="badge bg-warning badge-stock">
                                    <i class="bi bi-exclamation-triangle"></i> <span class="stock-value">{{ producto.stock }}</span>
                                </span>
                                {% else %}
                                <span class="badge bg-danger badge-stock">
                                    <i class="bi bi-x-circle"></i> Sin stock
                                </span>
                                {% endif %}
                            </div>
                            {% if es_admin %}
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-danger btn-stock-quick" 
                                        data-producto-id="{{ producto.id }}" 
                                        data-accion="restar" 
                                        data-cantidad="1"
                                        title="Restar 1 unidad">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success btn-stock-quick" 
                                        data-producto-id="{{ producto.id }}" 
                                        data-accion="sumar" 
                                        data-cantidad="1"
                                        title="Sumar 1 unidad">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if es_admin %}
                    <div class="d-flex gap-2 min-width-150">
                        <a href="{% url 'editar_producto' producto.id %}" class="btn btn-sm btn-warning flex-fill">
                            <i class="bi bi-pencil-square"></i> Editar
                        </a>
                        <a href="{% url 'eliminar_producto' producto.id %}" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar este producto?');" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-box-seam text-primary"></i>
                        <a href="{% url 'detalle_producto' producto.id %}" class="text-decoration-none text-dark">
                            {{ producto.nombre|truncatewords:8 }}
                        </a>
                    </h5>
                    <button class="btn btn-sm btn-link p-0 favorito-btn" 
                            data-producto-id="{{ producto.id }}"
                            data-favorito="{% if producto.id in favoritos_ids %}true{% else %}false{% endif %}"
                            onclick="toggleFavorito({{ producto.id }}, this)"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="{% if producto.id in favoritos_ids %}Quitar de favoritos - Accede rápido desde el menú{% else %}Agregar a favoritos - Accede rápido desde el menú{% endif %}">
                        <i class="bi {% if producto.id in favoritos_ids %}bi-star-fill text-warning{% else %}bi-star{% endif %} favorito-icon"></i>
                    </button>
                </div>
                {% if producto.categoria %}
                <div class="mb-2">
                    <span class="badge badge-categoria" style="background-color: {{ producto.categoria.color }};">
                        {{ producto.categoria.nombre }}
                    </span>
                </div>
                {% endif %}
                {% if producto.sku %}
                <small class="text-muted">SKU: {{ producto.sku }}</small>
                {% endif %}
                <hr>
                <div class="mb-3">
                    {% if producto.precio_promo %}
                    <div class="mb-2">
                        <span class="text-muted">Precio unidad:</span>
                        <div class="text-muted">${{ producto.precio|floatformat:0 }}</div>
                    </div>
                    <div>
                        <span class="text-muted">Precio promo:</span>
                        <div class="precio text-success"><strong>${{ producto.precio_promo|floatformat:0 }}</strong></div>
                    </div>
                    {% else %}
                    <span class="text-muted">Precio unidad:</span>
                    <div class="precio">${{ producto.precio|floatformat:0 }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Stock:</span>
                        {% if es_admin %}
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-danger btn-stock-quick" 
                                    data-producto-id="{{ producto.id }}" 
                                    data-accion="restar" 
                                    data-cantidad="1"
                                    title="Restar 1 unidad">
                                <i class="bi bi-dash"></i>
                            </button>
                            <button type="button" class="btn btn-outline-success btn-stock-quick" 
                                    data-producto-id="{{ producto.id }}" 
                                    data-accion="sumar" 
                                    data-cantidad="1"
                                    title="Sumar 1 unidad">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <div id="stock-display-{{ producto.id }}">
                        {% if producto.stock > 10 %}
                        <span class="badge bg-success badge-stock">
                            <i class="bi bi-check-circle"></i> <span class="stock-value">{{ producto.stock }}</span> unidades
                        </span>
                        {% elif producto.stock > 0 %}
                        <span class="badge bg-warning badge-stock">
                            <i class="bi bi-exclamation-triangle"></i> <span class="stock-value">{{ producto.stock }}</span> unidades
                        </span>
                        {% else %}
                        <span class="badge bg-danger badge-stock">
                            <i class="bi bi-x-circle"></i> Sin stock
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% if es_admin %}
                <hr>
                <div class="d-grid gap-2">
                    <a href="{% url 'editar_producto' producto.id %}" class="btn btn-sm btn-warning">
                        <i class="bi bi-pencil-square"></i> Editar
                    </a>
                    <a href="{% url 'eliminar_producto' producto.id %}" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar este producto?');">
                        <i class="bi bi-trash"></i> Eliminar
                    </a>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if productos.has_other_pages %}
<nav aria-label="Paginación" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if productos.has_previous %}
        <li class="page-item">
            <a class="page-link btn-pagination" href="?q={{ query }}&orden={{ orden }}&categoria={{ categoria_id }}&precio_min={{ precio_min }}&precio_max={{ precio_max }}&stock_bajo={{ stock_bajo }}&con_imagen={{ con_imagen }}&vista={{ vista }}&page={{ productos.previous_page_number }}">
                <i class="bi bi-chevron-left"></i> Anterior
            </a>
        </li>
        {% endif %}
        
        <li class="page-item active">
            <span class="page-link bg-primary text-white border-primary">Página {{ productos.number }} de {{ productos.paginator.num_pages }}</span>
        </li>
        
        {% if productos.has_next %}
        <li class="page-item">
            <a class="page-link btn-pagination" href="?q={{ query }}&orden={{ orden }}&categoria={{ categoria_id }}&precio_min={{ precio_min }}&precio_max={{ precio_max }}&stock_bajo={{ stock_bajo }}&con_imagen={{ con_imagen }}&vista={{ vista }}&page={{ productos.next_page_number }}">
                Siguiente <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-info text-center border-0 shadow-sm" role="alert" style="padding: 3rem;">
    <i class="bi bi-search" style="font-size: 4rem; color: #0dcaf0;"></i>
    <h4 class="mt-3">{% if query %}No se encontraron productos{% else %}No hay productos en el inventario{% endif %}</h4>
    <p class="mb-3">
        {% if query %}
        No encontramos productos que coincidan con "<strong>{{ query }}</strong>"
        {% else %}
        Aún no hay productos registrados en el sistema.
        {% endif %}
    </p>
    {% if query %}
    <div class="d-flex justify-content-center gap-2 flex-wrap">
        <a href="{% url 'inicio' %}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Ver todos los productos
        </a>
        <button onclick="document.getElementById('search-input').focus();" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Intentar otra búsqueda
        </button>
    </div>
    <div class="mt-4">
        <p class="text-muted small mb-2"><strong>Consejos para buscar:</strong></p>
        <ul class="list-unstyled text-muted small">
            <li><i class="bi bi-check-circle text-success"></i> Escribe solo parte del nombre (ej: "coca" en vez de "Coca Cola 500ml")</li>
            <li><i class="bi bi-check-circle text-success"></i> Verifica que no haya errores de ortografía</li>
            <li><i class="bi bi-check-circle text-success"></i> Intenta buscar por categoría en el menú desplegable</li>
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Mantener filtros avanzados abiertos si hay filtros activos
    document.addEventListener('DOMContentLoaded', function() {
        const precioMin = '{{ precio_min }}';
        const precioMax = '{{ precio_max }}';
        const stockBajo = '{{ stock_bajo }}';
        const conImagen = '{{ con_imagen }}';
        
        if (precioMin || precioMax || stockBajo || conImagen) {
            const filtrosAvanzados = document.getElementById('filtrosAvanzados');
            if (filtrosAvanzados) {
                filtrosAvanzados.classList.add('show');
            }
        }
        
        // Mejorar la experiencia de cambio de vista
        const vistaSelect = document.querySelector('select[name="vista"]');
        if (vistaSelect) {
            vistaSelect.addEventListener('change', function() {
                // Agregar una pequeña animación al cambiar de vista
                const productosContainer = document.querySelector('.row, .vista-lista');
                if (productosContainer) {
                    productosContainer.style.opacity = '0.5';
                    setTimeout(function() {
                        productosContainer.style.opacity = '1';
                    }, 200);
                }
            });
        }
    });
    
    // Función para toggle de favoritos
    window.toggleFavorito = function(productoId, button) {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        fetch(`/producto/${productoId}/favorito/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            const icon = button.querySelector('i');
            if (data.favorito) {
                icon.className = 'bi bi-star-fill text-warning';
                button.setAttribute('data-favorito', 'true');
                button.setAttribute('title', 'Quitar de favoritos');
            } else {
                icon.className = 'bi bi-star';
                icon.classList.remove('text-warning');
                button.setAttribute('data-favorito', 'false');
                button.setAttribute('title', 'Agregar a favoritos');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            window.location.reload();
        });
    };
    
    // ===== INICIALIZAR TOOLTIPS =====
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // ===== EDICIÓN RÁPIDA DE STOCK =====
    document.querySelectorAll('.btn-stock-quick').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const productoId = this.getAttribute('data-producto-id');
            const accion = this.getAttribute('data-accion');
            const cantidad = this.getAttribute('data-cantidad');
            
            // Deshabilitar botón mientras procesa
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            // Obtener CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken');
            
            fetch(`/producto/${productoId}/actualizar-stock/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `accion=${accion}&cantidad=${cantidad}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar display de stock en grid
                    const stockDisplay = document.getElementById(`stock-display-${productoId}`);
                    const stockValue = stockDisplay ? stockDisplay.querySelector('.stock-value') : null;
                    if (stockValue) {
                        stockValue.textContent = data.stock;
                    }
                    
                    // Actualizar display de stock en lista
                    const stockDisplayList = document.getElementById(`stock-display-list-${productoId}`);
                    const stockValueList = stockDisplayList ? stockDisplayList.querySelector('.stock-value') : null;
                    if (stockValueList) {
                        stockValueList.textContent = data.stock;
                    }
                    
                    // Actualizar badge según stock
                    if (stockDisplay) {
                        stockDisplay.innerHTML = '';
                        let badgeClass = 'bg-success';
                        let icon = 'bi-check-circle';
                        let text = `${data.stock} unidades`;
                        
                        if (data.stock === 0) {
                            badgeClass = 'bg-danger';
                            icon = 'bi-x-circle';
                            text = 'Sin stock';
                        } else if (data.stock_bajo) {
                            badgeClass = 'bg-warning';
                            icon = 'bi-exclamation-triangle';
                            text = `${data.stock} unidades`;
                        }
                        
                        stockDisplay.innerHTML = `<span class="badge ${badgeClass} badge-stock">
                            <i class="bi ${icon}"></i> <span class="stock-value">${data.stock}</span> ${data.stock === 0 ? '' : 'unidades'}
                        </span>`;
                    }
                    
                    if (stockDisplayList) {
                        stockDisplayList.innerHTML = '';
                        let badgeClass = 'bg-success';
                        let icon = 'bi-check-circle';
                        let text = data.stock.toString();
                        
                        if (data.stock === 0) {
                            badgeClass = 'bg-danger';
                            icon = 'bi-x-circle';
                            text = 'Sin stock';
                        } else if (data.stock_bajo) {
                            badgeClass = 'bg-warning';
                            icon = 'bi-exclamation-triangle';
                            text = data.stock.toString();
                        }
                        
                        stockDisplayList.innerHTML = `<span class="badge ${badgeClass} badge-stock">
                            <i class="bi ${icon}"></i> <span class="stock-value">${data.stock}</span>
                        </span>`;
                    }
                    
                    // Mostrar mensaje de éxito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle"></i> ${data.mensaje}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    setTimeout(() => alertDiv.remove(), 3000);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar el stock'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar el stock. Por favor intenta de nuevo.');
            })
            .finally(() => {
                // Restaurar botón
                this.disabled = false;
                this.innerHTML = originalHTML;
            });
        });
    });
    
    // ===== LECTOR DE CÓDIGO DE BARRAS USB =====
    // Los lectores USB envían el código + Enter automáticamente
    // Este código detecta entrada rápida (típica de escáneres) y busca automáticamente
    let barcodeBuffer = '';
    let barcodeTimeout = null;
    
    document.addEventListener('keypress', function(e) {
        // Si el foco está en un input que no es el de búsqueda, ignorar
        if (document.activeElement.tagName === 'INPUT' && document.activeElement.id !== 'search-input') {
            return;
        }
        
        // Si es Enter y hay algo en el buffer, buscar
        if (e.key === 'Enter' && barcodeBuffer.length > 3) {
            e.preventDefault();
            document.getElementById('search-input').value = barcodeBuffer;
            document.getElementById('search-form').submit();
            barcodeBuffer = '';
            return;
        }
        
        // Acumular caracteres (los escáneres escriben muy rápido)
        if (e.key.length === 1) {
            barcodeBuffer += e.key;
            
            // Limpiar buffer después de 100ms de inactividad
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(() => {
                barcodeBuffer = '';
            }, 100);
        }
    });
</script>
{% endblock %}

{% block ayuda %}
{% include 'inventario/ayuda_contextual.html' %}
{% endblock %}

